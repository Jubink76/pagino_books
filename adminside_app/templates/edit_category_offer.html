{% extends 'admin_base.html' %}
{% load static %}

{% block csslink %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
{% endblock %}
{% block content %}
<div class="col-md-9 ms-sm-auto col-lg-10 offset-md-3 offset-lg-2">
    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
        <!-- Header Section -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-white text-2xl font-medium">
                Edit Category Offer
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="flex space-x-2 text-sm text-gray-400">
                    <li><a href="#" class="hover:text-white">Admin</a></li>
                    <li>/</li>
                    <li><a href="#" class="hover:text-white">offers</a></li>
                    <li>/</li>
                    <li class="text-white">Edit Category Offers</li>
                </ol>
            </nav>
        </div>

        <!-- Offer Form -->
        <form id="offer-form" method="post" class="space-y-6" data-url="{% url 'edit_category_offer' category.id %}">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Offer Title -->
                <div>
                    <label class="block text-gray-300 font-medium mb-2">Offer Title</label>
                    <input type="text" class="bg-gray-700 text-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           placeholder="Enter offer title" 
                           name="offer_name"
                           value="{{ offer.offer_name }}">
                </div>
        
                <!-- Offer Type -->
                <div>
                    <label class="block text-gray-300 font-medium mb-2">Offer Type</label>
                    <input type="text" class="bg-gray-700 text-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           name="offer_type"
                           value="{{ offer.offer_type }}"
                           readonly>
                </div>
                
                <!-- Discount Type -->
                <div>
                    <label class="block text-gray-300 font-medium mb-2">Discount Type</label>
                    <select class="bg-gray-700 text-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" name="discount_type">
                        <option value="percentage" {% if offer.discount_type == 'percentage' %}selected{% endif %}>Percentage</option>
                        <option value="fixed" {% if offer.discount_type == 'fixed' %}selected{% endif %}>Fixed Amount</option>
                        <option value="bogo" {% if offer.discount_type == 'bogo' %}selected{% endif %}>Buy One Get One</option>
                        <option value="bundle" {% if offer.discount_type == 'bundle' %}selected{% endif %}>Bundle Discount</option>
                    </select>
                </div>
        
                <!-- Discount Value -->
                <div>
                    <label class="block text-gray-300 font-medium mb-2">Discount Value</label>
                    <input type="number" class="bg-gray-700 text-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           placeholder="Enter value" 
                           name="discount_value"
                           value="{{ offer.discount_value }}">
                </div>
        
                <!-- Valid From -->
                <div>
                    <label class="block text-gray-300 font-medium mb-2">Valid From</label>
                    <input type="datetime-local" 
                           id="valid-from"
                           class="bg-gray-700 text-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           name="valid_from"
                           value="{{ offer.valid_from|date:'Y-m-d\TH:i' }}"
                           novalidate>
                </div>
        
                <!-- Valid Until -->
                <div>
                    <label class="block text-gray-300 font-medium mb-2">Valid Until</label>
                    <input type="datetime-local" 
                           id="valid-to"
                           class="bg-gray-700 text-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           name="valid_to"
                           value="{{ offer.valid_to|date:'Y-m-d\TH:i' }}"
                           novalidate>
                </div>
        
                <!-- Description -->
                <div class="md:col-span-2">
                    <label class="block text-gray-300 font-medium mb-2">Offer Description</label>
                    <textarea class="bg-gray-700 text-gray-300 rounded-md px-4 py-2 w-full h-24 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                              placeholder="Enter offer description" 
                              name="description">{{ offer.description }}</textarea>
                </div>
        
                <!-- Active status -->
                <div class="flex items-center space-x-2">
                    <input 
                        type="checkbox" 
                        name="is_active" 
                        id="active-status"
                        class="w-4 h-4 text-blue-500 border-gray-300 rounded focus:ring-blue-500"
                        {% if offer.is_active %}checked{% endif %}
                    >
                    <label for="active-status" class="text-gray-300 font-medium">
                        Active Status
                    </label>
                </div>
            </div>
        
            <!-- Form Buttons -->
            <div class="flex justify-end space-x-4">
                <button type="button" onclick="window.location.href='{% url 'admin_category' %}'" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-600">Cancel</button>
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Update Offer
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block script %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const validFromInput = document.getElementById('valid-from');
    const validToInput = document.getElementById('valid-to');
    const form = document.querySelector('#couponForm');
    const isEditMode = form.hasAttribute('data-edit');

    // Store the original values
    const originalFromValue = validFromInput.value;
    const originalToValue = validToInput.value;

    // Function to get current date in YYYY-MM-DDThh:mm format
    function getCurrentDateTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // Function to set end of day time (23:59) for valid_to
    function setEndOfDay() {
        if (validToInput.value) {
            const date = validToInput.value.split('T')[0];
            validToInput.value = `${date}T23:59`;
        }
    }

    // Function to check if a date is in the past
    function isDateInPast(dateStr) {
        const currentDateTime = new Date();
        const selectedDateTime = new Date(dateStr);
        return selectedDateTime < currentDateTime;
    }

    // Function to update validation rules based on edit mode
    function updateDateTimeValidation() {
        const currentDateTime = getCurrentDateTime();
        
        if (!isEditMode) {
            // For new coupons, enforce future dates
            validFromInput.min = currentDateTime;
            validToInput.min = currentDateTime;

            if (validFromInput.value && isDateInPast(validFromInput.value)) {
                validFromInput.value = currentDateTime;
            }
            
            if (validToInput.value && isDateInPast(validToInput.value)) {
                validToInput.value = currentDateTime;
            }
        } else {
            // For editing, preserve original dates
            if (validFromInput.value === '') {
                validFromInput.value = originalFromValue;
            }
            if (validToInput.value === '') {
                validToInput.value = originalToValue;
            }
        }

        // Always ensure valid-to is after valid-from
        if (validFromInput.value && validToInput.value) {
            const fromDate = new Date(validFromInput.value);
            const toDate = new Date(validToInput.value);
            
            if (toDate < fromDate) {
                if (isEditMode && originalToValue) {
                    validToInput.value = originalToValue;
                } else {
                    validToInput.value = validFromInput.value;
                    setEndOfDay();
                }
            }
        }
    }

    // Add event listeners for date changes
    validFromInput.addEventListener('change', function() {
        if (this.value !== originalFromValue) {
            // Only modify if it's not the original value
            if (isDateInPast(this.value)) {
                this.value = getCurrentDateTime();
            }
            
            // Update valid-to if needed
            if (this.value && validToInput.value) {
                const selectedDateTime = new Date(this.value);
                const validToDate = new Date(validToInput.value);
                if (validToDate < selectedDateTime) {
                    validToInput.value = this.value;
                    setEndOfDay();
                }
            }
        }
    });

    validFromInput.addEventListener('change', function() {
        if (!isEditMode || this.value !== originalFromValue) {
            if (!isEditMode && isDateInPast(this.value)) {
                this.value = getCurrentDateTime();
            }
            updateDateTimeValidation();
        }
    });

    validToInput.addEventListener('change', function() {
        if (!isEditMode || this.value !== originalToValue) {
            if (!isEditMode && isDateInPast(this.value)) {
                this.value = getCurrentDateTime();
            }
            updateDateTimeValidation();
            setEndOfDay();
        }
    });

    updateDateTimeValidation();

    // Create a MutationObserver to watch for dynamically added min attributes
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === "attributes" && mutation.attributeName === "min") {
                const target = mutation.target;
                if (target.value === (target === validFromInput ? originalFromValue : originalToValue)) {
                    // Remove min attribute for original values
                    target.removeAttribute("min");
                }
            }
        });
    });

    // Start observing both inputs for min attribute changes
    observer.observe(validFromInput, { attributes: true });
    observer.observe(validToInput, { attributes: true });

    // Form submission handling
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById("offer-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const form = this;
            const url = form.getAttribute("data-url");
            const formData = new FormData(form);

            fetch(url, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]").value
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    Swal.fire({
                        title: "Success!",
                        text: data.message,
                        icon: "success",
                        confirmButtonText: "OK",
                    }).then(() => {
                        window.location.href = data.redirect_url;
                    });
                } else {
                    Swal.fire({
                        title: "Error!",
                        text: data.message,
                        icon: "error",
                        confirmButtonText: "Try Again",
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    title: "Error!",
                    text: "Something went wrong. Please try again later.",
                    icon: "error",
                    confirmButtonText: "OK",
                });
            });
        });
    });
</script>
{% endblock %}